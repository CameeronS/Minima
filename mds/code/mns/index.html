<html>

<head>
	<title>MNS</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- Load the main MDS JS lib -->
	<script type="text/javascript" src="mds.js"></script>
	
	<!-- Load the CSS Style sheet -->
	<link rel="stylesheet" href="style.css">
	
	<!-- And the ICON for the page -->
	<link rel="icon" type="image/x-icon" href="favicon.ico">
	
	<!-- Load the local JS lib -->
	<script type="text/javascript" src="jslib.js"></script>
	<script type="text/javascript" src="sql.js"></script>
	<script type="text/javascript" src="txns.js"></script>
	
</head>

<body>

<center>
	<br>
	<h2>Minima Name Service</h2>
	<br>

	Name : <input type="text" id="searchname"/> <button onclick="searchName();">SEARCH</button>
	<br><br>
	<textarea rows="10" cols="80" id="searchresults"></textarea>
	<br>
	<br>
	Register : 	<input type="text" id="registername"/> <button onclick="registerName();">REGISTER</button>
	<br><br>
	
	<div id="mydomains">
	
	</div>
	
</center>

<script type="text/javascript">
	
	var USER_OWNER 		= "";
	var USER_ADDRESS 	= "";
	
	function searchain(name,callback){
		var search = "coins address:"+MNS_ADDRESS+" state:"+name+" order:asc simplestate:true";
		MDS.cmd(search,function(resp){
			if(resp.status){
				var len = resp.response.length;
				for(var i=0;i<len;i++){
					var coin = resp.response[i];
					//Check the correct exact name..
					if(coin.state[2] == "["+name+"]"){
						callback(coin);
						return;
					}
				}
			}
			
			//Not found..
			callback(null);
		});
	}
	
	function searchDB(name,callback){
		findName(name,function(res){
			if(res.length>0){
				callback(res[0]);	
			}else{
				callback(null);	
			}
		});
	}
	
	function searchName(){
		var name = document.getElementById("searchname").value;
		
		//First search the DB.. these are older
		searchDB(name,function(res){
			
			//Did we find it..
			if(res){
				var showdata = {};
				showdata.FOUND   = "DATABASE";
				showdata.ID  	 = res.ID;
				showdata.OWNER   = res.OWNER;
				showdata.NAME  	 = res.NAME;
				showdata.DATA  	 = JSON.parse(res.DATA);
				showdata.UPDATED = res.UPDATED;
				searchresults.value = JSON.stringify(showdata,null,2);
			}else{
				
				//Now search the chain..
				searchain(name,function(res){
					if(res){
						var showdata = {};
						showdata.FOUND   = "ONCHAIN";
						showdata.OWNER   = stripBrackets(res.state[0]);
						showdata.NAME  	 = stripBrackets(res.state[2]);
						showdata.DATA  	 = JSON.parse(stripBrackets(res.state[3]));
						searchresults.value = JSON.stringify(showdata,null,2);
					}else{
						
						//Not found anywhere..
						searchresults.value = "Not Found..";
					}
				});
			}
		});
	}
	
	function registerName(){
		var name = document.getElementById("registername").value;
		var data = {};
		data.address = USER_ADDRESS;
		var datastr = JSON.stringify(data);
		
		sendNameUpdate(USER_OWNER, USER_OWNER, name, datastr, function(resp){
			MDS.log("REGISTER SENT:"+resp.status);
		});
	}
	
	function setMyDomains(){
		
		findMyDomains(USER_OWNER,function(resp){
			var len  = resp.length;
			var list = "MY DOMAINS<br><br>";
			for(var i=0;i<len;i++){
				var record = resp[i];
				
				list += record.NAME+" "+record.DATA+"<br>";
			}
			
			mydomains.innerHTML = list;
		});
	}
	
	function makeDomainRow(){
		var text = "";
		//text +
	}
	
	//Main message handler..
	MDS.init(function(msg){
		
		//Do initialisation
		if(msg.event == "inited"){
			
			//Create the DB
			createDB(function(res){
				//Notify of new messages..
				MDS.cmd("coinnotify action:add address:"+MNS_ADDRESS,function(startup){});
				
			});		
			
			MDS.cmd("keys;getaddress",function(resp){
				USER_OWNER 	 = resp[0].response.keys[0].publickey;
				MDS.log("OWNER : "+USER_OWNER);
				USER_ADDRESS = resp[1].response.miniaddress;
				MDS.log("ADDRESS : "+USER_ADDRESS);
				
				setMyDomains();
			});
			
		}else if(msg.event == "NOTIFYCASCADECOIN"){
			
			//Is it the one that matters
			if(msg.data.address ==  MNS_ADDRESS){
				
				//Check is Valid amount..
				if(msg.data.coin.tokenid != "0x00"){
					MDS.log("Message not sent as Minima.. ! "+msg.data.coin.tokenid);
					return;
				}else if(+msg.data.coin.amount < 1){
					MDS.log("Message below 1 Minima threshold.. ! "+msg.data.coin.amount);
					return;
				}
				
				//Get the coin..
				var block 		= msg.data.txblock;
				var coinstate  	= msg.data.coin.state;

				var owner 		= stripBrackets(coinstate[0]);
				var transfer 	= stripBrackets(coinstate[1]);
				var name 		= stripBrackets(coinstate[2]);
				var datastr		= stripBrackets(coinstate[3]);
				var sig			= coinstate[4];
				
				//check sig..
				//..
				
				//Update DB..
				MDS.log("CASCADE NOTIFY : "+JSON.stringify(msg.data));
				updateName(owner, transfer, name, datastr, block, function(resp){
					MDS.log(resp)
				});
			}
			
		}
	});

</script>

</body>

</html>