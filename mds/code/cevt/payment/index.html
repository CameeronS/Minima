<html>

<head>
	<title>KJ PAYMENT</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="mds.js"></script>
</head>

<body>

<center>

	<br>

	<h2>KJ PAYMENT DAPP</h2>
<br>
<div id="kjbalance">Current balance</div><br>

<table>
	<tr>
		<td>Terminal ID:</td>
		<td><input type=text id=terminalid value="0x0001"> </td>
	</tr>
	<tr>
		<td>Amount:</td>
		<td><input type=number id=reqamount> </td>
	</tr>
</table>
<br>
<button onclick="requestToken();">REQUEST TOKEN</button><br>

<br>
<br>
<br>
<div id="kjtokens">Current ACTs</div><br>


<script type="text/javascript">

	//Some static variables
	const KJ_TOKENID 		= "0x050D2DD42E2EC376E06B2AB5731E7DF550371B286B9FB4C9E1197A667BB28F8B";
	const KJ_ACT_TOKENID 	= "0x14350C289B7A5BF0BE2BFADDB7766DF75C153C0365E9A3D4E2236894C014CAE6";
	const PAY_ADDRESS 		= "MxG0866UJHK16J9304ETBSUGZMTB6R5YA7PRS1QRZGRSMR2FZYFYA66JT2V8QZG";
	
	var USER_ADDRESS 		= "";
	var USER_PUBKEY 		= "";
	
	/**
	 * Remove a spent ACT token
	 */
	function removeSpent(id){
		if(confirm("Are you sure ?")){
			MDS.cmd("cointrack enable:false coinid:"+id,function(result){
				MDS.log(JSON.stringify(result));
				
				updateViews();
			});	
		}
	}
	 
	/**
	 * Print out an ACT token
	 */
	function printToken(coin){
		
		var tokenview = "";
		
		//Get the details..
		var tid 		= MDS.util.getStateVariable(coin,0);
		var tokamount 	= MDS.util.getStateVariable(coin,2);
		
		tokenview +="<table border=1>";
		
		tokenview +="<tr><td>Terminal:</td><td>"+tid+"</td></tr>";
		tokenview +="<tr><td>Amount:</td><td>"+tokamount+"</td></tr>";
		tokenview +="<tr><td>"+coin.coinid+"</td></tr>";
		tokenview +="<tr><td style='text-align:right;'><button onclick='removeSpent(\""+coin.coinid+"\")'>REMOVE SPENT</button></td></tr>";
		
		tokenview +="</table>";
		
		return tokenview;	
	}
	
	/**
	 * Update the Balance Views
	 */
	function updateViews(){
		
		var kjbaldiv 	= document.getElementById("kjbalance");
		var actbaldiv 	= document.getElementById("kjtokens");
		
		//The Energy base token..
		MDS.cmd("balance tokenid:"+KJ_TOKENID,function(result){
			if(result.response.length > 0){
				kjbaldiv.innerHTML = "Current KJ balance : "+result.response[0].sendable;
			}else{
				kjbaldiv.innerHTML = "No KJ Energy..";	
			}
		});
		
		//The ACT tokens
		MDS.cmd("coins relevant:true tokenid:"+KJ_ACT_TOKENID,function(result){
			
			//How many coins
			var coinlen = result.response.length;
			if(coinlen==0){
				actbaldiv.innerHTML = "No Acces Control Tokens..";
			}else{
				var output = "";	
				for(var i=0;i<coinlen;i++){
					var coin = result.response[i];
					
					//Get the ACT data..
					output +=printToken(coin)+"<br><br>";
				}
				
				actbaldiv.innerHTML = output;
			}
		});
	}

	/**
	 * Request an Access Token
	 */
	function requestToken(){
		
		//How much..
		var amount 		= document.getElementById("reqamount").value;
		var terminal 	= document.getElementById("terminalid").value;
		
		//Confirm
		var conf = confirm("Are you sure ?\n\nYou are about to request "+amount+" Energy Tokens from Terminal "+terminal+"..");		
		if(conf){
			//Blank it..
			document.getElementById("reqamount").value = "";
			
			//And now send the funds with the correct state variables..
			//var state="{\"0\":\""+USER_ADDRESS+"\",\"1\":\""+terminal+"\",}";
			var state='{"0":"'+USER_ADDRESS+'","1":"'+terminal+'","2":"'+USER_PUBKEY+'"}';
			
			var sendfunc = "send amount:"+amount+" address:"+PAY_ADDRESS+" tokenid:"+KJ_TOKENID+" state:"+state;
			
			MDS.cmd(sendfunc,function(result){
				MDS.log(JSON.stringify(result));
				
				if(result.status){
					alert("Request Sent!");	
				}else if(result.pending){
					alert("Pending Transaction! Pls confirm..");	
				}else{
					alert("Something went wrong..\n\n"+result.message);
				}
			});
		}
	}
	
	//Main message handler..
	MDS.init(function(msg){
		//Do initialisation
		if(msg.event == "inited"){
			
			//Get an address
			MDS.cmd("getaddress",function(result){
				//Use this as the payback address
				USER_ADDRESS = result.response.miniaddress;
				MDS.log("USER ADDRESS: "+USER_ADDRESS);
				
				//Get the Public Key for signing..
				MDS.cmd("maxima",function(result){
					//Use this as the user pubkey
					USER_PUBKEY = result.response.publickey;
					MDS.log("USER PUBKEY: "+USER_PUBKEY);
					
					//Now Update the views..
					updateViews();
				});
			});
		
		}else if(msg.event == "NEWBLOCK"){
			updateViews();
		}
		
	});
	
</script>
	
</center>

</body>

</html>